# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a booking application for Jamboree 2026, built with Gleam and PostgreSQL. It enables participants to book various activities during the event.

## Essential Commands

### Development
```sh
gleam run                          # Run the web server (starts on port 8000)
gleam test                         # Run tests
gleam run -m squirrel              # Regenerate Gleam modules from SQL (run after modifying SQL files)
```

### Database Setup
```sh
# Set database URL
export DATABASE_URL="postgres://postgres@localhost:5432/j26booking"

# Run migrations
gleam run -m cigogne last

# Seed database with example activities
psql "$DATABASE_URL" -f priv/seeding/activities.sql
```

## Architecture

### Tech Stack
- **Web Framework**: Mist + Wisp (Gleam web server)
- **Frontend**: Lustre (SSR) + HTMX + TailwindCSS
- **Database**: PostgreSQL with Squirrel (type-safe queries) and Cigogne (migrations)

### Application Structure

The app uses a supervised architecture with two main components:
1. **Database pool** (`pog.supervised`): Connection pool to PostgreSQL
2. **Web server** (`wisp_mist.supervised`): HTTP server on port 8000

Both are managed by a RestForOne supervisor in `src/j26booking.gleam:36-39`.

### Key Modules

- **`src/j26booking.gleam`**: Entry point, sets up supervision tree and database connection
- **`src/j26booking/router.gleam`**: Request routing and handlers
- **`src/j26booking/web.gleam`**: Middleware configuration and Context type
- **`src/j26booking/components.gleam`**: Lustre components for SSR
- **`src/j26booking/data.gleam`**: Data transformation utilities
- **`src/j26booking/sql.gleam`**: Generated by Squirrel (DO NOT EDIT MANUALLY)

### Database Workflow

1. **Schema changes**: Add SQL files to `priv/migrations/`
2. **Queries**: Add `.sql` files to `src/j26booking/sql/`
3. **Regenerate**: Run `gleam run -m squirrel` to generate type-safe Gleam code in `src/j26booking/sql.gleam`
4. **Apply migrations**: Run `gleam run -m cigogne last`

The database connection is hardcoded to `localhost:5432` with database name `j26booking` and user `postgres` (no password).

### Request Flow

```
Request → web.middleware → router.handle_request → handler functions
                ↓
        (static files, logging, crash recovery)
```

Routes are defined in `src/j26booking/router.gleam:12-17`:
- `/` → redirects to `/index.html`
- `/activities` → lists all activities from database
- `/book/:id` → booking endpoint (placeholder)

### Database Schema (MVP)

Core tables:
- **user**: id, role (organizer/booker/admin)
- **activity**: id, title, description, max_attendees, start_time, end_time
- **booking**: id, user_id, activity_id, group, responsible, phone_number, participant_count
- **activity_user**: many-to-many between activities and organizers

See README.md for detailed schema diagram including extra features.

## Gleam and Functional Programming Best Practices

### Error Handling

- **Always use Result types**: Handle errors explicitly with `Result(a, e)` instead of exceptions
- **Pattern match on Results**: Always pattern match to handle both `Ok` and `Error` cases:
  ```gleam
  case result {
    Ok(value) -> // handle success
    Error(error) -> // handle failure
  }
  ```
- **Use `use` expressions**: Simplify nested Result handling with the `use` syntax:
  ```gleam
  use value <- result.try(operation())
  // Continue with value
  ```
- **Exhaustive pattern matching**: Ensure all cases are handled in `case` expressions to prevent runtime errors

### Type Safety

- **Leverage the type system**: Let the compiler catch errors at compile-time rather than runtime
- **Pattern match on custom types**: Extract data from custom types using pattern matching:
  ```gleam
  pub fn to_string(pokemon: Pokemon) {
    let Pokemon(pokedex_number:, name:) = pokemon
    // Use extracted fields
  }
  ```
- **Avoid underscore variables in logic**: Use meaningful names for clarity; `_` should only be used for truly unused values

### Code Organization

- **Pure functions**: Prefer pure functions that don't produce side effects
- **Small, focused functions**: Break complex operations into smaller, composable functions
- **Use pipelines**: Chain operations with `|>` for clarity:
  ```gleam
  list
  |> list.map(transform)
  |> list.filter(predicate)
  |> list.first
  ```

### Pattern Matching

- **Match early, match often**: Use pattern matching to destructure data at function boundaries
- **Alternative patterns with care**: Ensure all patterns define the same variables
- **Label fields in patterns**: Use labelled fields for clarity: `Person(name:, age:)`

### Best Practices for This Project

- **Use Squirrel for queries**: Never hand-write SQL strings; always use `.sql` files and regenerate with `gleam run -m squirrel`
- **Handle database Results**: Database operations return `Result` types—always handle both success and failure
- **Validate input early**: Pattern match and validate request data at handler entry points
- **Type-safe routing**: Use Wisp's routing helpers to ensure type-safe path parameter extraction
